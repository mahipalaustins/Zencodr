<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Code Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Chat Bot Panel */
        .chat-panel {
            width: 350px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            position: relative;
        }

        .chat-panel.open {
            transform: translateX(0);
        }

        .chat-toggle {
            position: absolute;
            left: -40px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: #007acc;
            border: none;
            border-radius: 8px 0 0 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 1000;
        }

        .chat-toggle:hover {
            background: #005a9e;
        }

        .chat-header {
            padding: 15px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 14px;
            font-weight: 600;
            color: #cccccc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-close {
            background: none;
            border: none;
            color: #cccccc;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 14px;
        }

        .chat-close:hover {
            background: #3e3e42;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 10px;
            border-radius: 8px;
            max-width: 90%;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.4;
        }

        .message.user {
            background: #007acc;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.ai {
            background: #2d2d30;
            color: #cccccc;
            align-self: flex-start;
            border: 1px solid #3e3e42;
        }

        .message.ai code {
            background: #1e1e1e;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .message.ai pre {
            background: #1e1e1e;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .chat-input-container {
            padding: 15px;
            background: #2d2d30;
            border-top: 1px solid #3e3e42;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #cccccc;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            resize: none;
            min-height: 36px;
            max-height: 120px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .chat-send {
            background: #007acc;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send:hover {
            background: #005a9e;
        }

        .chat-send:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            color: #888;
            font-style: italic;
            font-size: 12px;
        }

        .typing-indicator.show {
            display: block;
        }

        .code-action-buttons {
            margin-top: 8px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .code-action-btn {
            background: #007acc;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .code-action-btn:hover {
            background: #005a9e;
        }

        .code-action-btn.secondary {
            background: #3e3e42;
        }

        .code-action-btn.secondary:hover {
            background: #4e4e52;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 10px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: #cccccc;
        }

        .file-actions {
            display: flex;
            gap: 5px;
        }

        .file-action-btn {
            background: none;
            border: none;
            color: #cccccc;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .file-action-btn:hover {
            background: #3e3e42;
        }

        .file-explorer {
            flex: 1;
            overflow-y: auto;
            padding: 5px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 13px;
            user-select: none;
        }

        .file-item:hover {
            background: #2a2d2e;
        }

        .file-item.active {
            background: #094771;
        }

        .file-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            font-size: 12px;
        }

        .file-name {
            flex: 1;
        }

        .file-context-menu {
            position: absolute;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 4px 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: #094771;
        }

        /* Main Editor Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Tab Bar */
        .tab-bar {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            overflow-x: auto;
            min-height: 35px;
            position: relative;
        }

        .tab-bar::-webkit-scrollbar {
            height: 4px;
        }

        .tab-bar::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .tab-bar::-webkit-scrollbar-thumb {
            background: #3e3e42;
            border-radius: 2px;
        }

        .tab {
            padding: 8px 16px;
            background: #2d2d30;
            border-right: 1px solid #3e3e42;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            min-width: 120px;
            max-width: 200px;
            position: relative;
            transition: all 0.2s ease;
            user-select: none;
        }

        .tab:hover {
            background: #3e3e42;
        }

        .tab.active {
            background: #1e1e1e;
            border-bottom: 2px solid #007acc;
            color: #ffffff;
        }

        .tab.active:hover {
            background: #1e1e1e;
        }

        .tab-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }

        .tab-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tab-close {
            cursor: pointer;
            padding: 2px;
            border-radius: 2px;
            font-size: 11px;
            opacity: 0.7;
            transition: all 0.2s ease;
            margin-left: 4px;
        }

        .tab-close:hover {
            background: #e74c3c;
            opacity: 1;
            color: white;
        }

        .tab-unsaved {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            background: #f39c12;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tab-unsaved.show {
            opacity: 1;
        }

        .tab-dirty .tab-name::after {
            content: ' •';
            color: #f39c12;
            font-weight: bold;
        }

        /* Tab context menu */
        .tab-context-menu {
            position: absolute;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 4px 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tab-context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .tab-context-menu-item:hover {
            background: #094771;
        }

        .tab-context-menu-item.disabled {
            color: #666;
            cursor: not-allowed;
        }

        .tab-context-menu-item.disabled:hover {
            background: transparent;
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            position: relative;
        }

        .editor {
            width: 100%;
            height: 100%;
        }

        /* Status Bar */
        .status-bar {
            background: #007acc;
            color: white;
            padding: 4px 12px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            padding: 20px;
            min-width: 300px;
        }

        .modal-header {
            margin-bottom: 15px;
            font-weight: 600;
        }

        .modal-input {
            width: 100%;
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #cccccc;
            border-radius: 3px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-secondary {
            background: #3e3e42;
            color: #cccccc;
        }

        .btn:hover {
            opacity: 0.8;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3e3e42;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e52;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-folder"></i>
                <span class="sidebar-title">EXPLORER</span>
                <div class="file-actions">
                    <button class="file-action-btn" onclick="createNewFile()" title="New File">
                        <i class="fas fa-file-plus"></i>
                    </button>
                    <button class="file-action-btn" onclick="createNewFolder()" title="New Folder">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                </div>
            </div>
            <div class="file-explorer" id="fileExplorer">
                <!-- File tree will be populated here -->
            </div>
        </div>

        <!-- Main Editor Area -->
        <div class="main-area">
            <!-- Tab Bar -->
            <div class="tab-bar" id="tabBar">
                <!-- Tabs will be populated here -->
            </div>

            <!-- Editor Container -->
            <div class="editor-container">
                <div class="editor" id="editor"></div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <i class="fas fa-code"></i>
                    <span id="languageText">Plain Text</span>
                </div>
                <div class="status-item">
                    <span id="cursorPosition">Ln 1, Col 1</span>
                </div>
            </div>
        </div>

        <!-- AI Chat Bot Panel -->
        <div class="chat-panel" id="chatPanel">
            <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">
                <i class="fas fa-robot"></i>
            </button>
            
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    AI Assistant
                </div>
                <button class="chat-close" onclick="toggleChat()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <strong>AI Assistant:</strong> Hello! I'm here to help you write and modify code. You can ask me to:
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>Write new code</li>
                        <li>Modify existing code</li>
                        <li>Debug issues</li>
                        <li>Explain code</li>
                        <li>Suggest improvements</li>
                    </ul>
                    <br>
                    <em>Note: Gemini API connection will be tested when you first open the chat.</em>
                    <br><br>
                    What would you like me to help you with?
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                AI is typing...
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Ask me to write or modify code..."
                        rows="1"
                    ></textarea>
                    <button class="chat-send" id="chatSend" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="file-context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="renameFile()">
            <i class="fas fa-edit"></i>
            Rename
        </div>
        <div class="context-menu-item" onclick="deleteFile()">
            <i class="fas fa-trash"></i>
            Delete
        </div>
        <div class="context-menu-item" onclick="duplicateFile()">
            <i class="fas fa-copy"></i>
            Duplicate
        </div>
    </div>

    <!-- Tab Context Menu -->
    <div class="tab-context-menu" id="tabContextMenu">
        <div class="tab-context-menu-item" onclick="closeTab()">
            <i class="fas fa-times"></i>
            Close Tab
        </div>
        <div class="tab-context-menu-item" onclick="closeOtherTabs()">
            <i class="fas fa-times-circle"></i>
            Close Other Tabs
        </div>
        <div class="tab-context-menu-item" onclick="closeAllTabs()">
            <i class="fas fa-window-close"></i>
            Close All Tabs
        </div>
        <div class="tab-context-menu-item" onclick="duplicateTab()">
            <i class="fas fa-copy"></i>
            Duplicate Tab
        </div>
        <div class="tab-context-menu-item" onclick="saveTab()">
            <i class="fas fa-save"></i>
            Save Tab
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">New File</div>
            <input type="text" class="modal-input" id="modalInput" placeholder="Enter file name">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // File system structure
        let fileSystem = {
            'src': {
                type: 'folder',
                children: {
                    'index.html': {
                        type: 'file',
                        content: '<!DOCTYPE html>\n<html>\n<head>\n    <title>My Project</title>\n</head>\n<body>\n    <h1>Hello World</h1>\n</body>\n</html>',
                        language: 'html'
                    },
                    'style.css': {
                        type: 'file',
                        content: 'body {\n    font-family: Arial, sans-serif;\n    margin: 0;\n    padding: 20px;\n    background-color: #f0f0f0;\n}\n\nh1 {\n    color: #333;\n}',
                        language: 'css'
                    },
                    'script.js': {
                        type: 'file',
                        content: 'console.log("Hello World");\n\nfunction greet() {\n    alert("Welcome to my project!");\n}\n\ngreet();',
                        language: 'javascript'
                    }
                }
            },
            'README.md': {
                type: 'file',
                content: '# My Project\n\nWelcome to my web project!\n\n## Features\n- Modern design\n- Responsive layout\n- Clean code',
                language: 'markdown'
            }
        };

        let editor;
        let openFiles = [];
        let activeFile = null;
        let contextMenuTarget = null;
        let modalCallback = null;
        let tabContextMenuTarget = null;
        
        // Chat bot variables
        let chatOpen = false;
        let chatHistory = [];
        const GEMINI_API_KEY = 'AIzaSyD5Zx328mZbNgO22nRiTOHQwOYpizW5ofY';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '// Welcome to Web Code Editor\n// Start by opening a file from the explorer',
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                lineNumbers: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
                minimap: { enabled: true }
            });

            // Update cursor position
            editor.onDidChangeCursorPosition((e) => {
                document.getElementById('cursorPosition').textContent = 
                    `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
            });
        });

        // File system functions
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function getLanguageFromExtension(extension) {
            const languageMap = {
                'js': 'javascript',
                'ts': 'typescript',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'md': 'markdown',
                'py': 'python',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c',
                'php': 'php',
                'rb': 'ruby',
                'go': 'go',
                'rs': 'rust',
                'sql': 'sql',
                'xml': 'xml',
                'yaml': 'yaml',
                'yml': 'yaml'
            };
            return languageMap[extension] || 'plaintext';
        }

        function getFileIcon(filename, type) {
            if (type === 'folder') {
                return '<i class="fas fa-folder file-icon"></i>';
            }
            
            const extension = getFileExtension(filename);
            const iconMap = {
                'js': '<i class="fab fa-js-square file-icon" style="color: #f7df1e;"></i>',
                'html': '<i class="fab fa-html5 file-icon" style="color: #e34c26;"></i>',
                'css': '<i class="fab fa-css3-alt file-icon" style="color: #1572b6;"></i>',
                'json': '<i class="fas fa-file-code file-icon" style="color: #000;"></i>',
                'md': '<i class="fab fa-markdown file-icon" style="color: #083fa1;"></i>',
                'py': '<i class="fab fa-python file-icon" style="color: #3776ab;"></i>',
                'java': '<i class="fab fa-java file-icon" style="color: #007396;"></i>',
                'cpp': '<i class="fas fa-file-code file-icon" style="color: #00599c;"></i>',
                'php': '<i class="fab fa-php file-icon" style="color: #777bb4;"></i>'
            };
            
            return iconMap[extension] || '<i class="fas fa-file file-icon"></i>';
        }

        function renderFileExplorer() {
            const explorer = document.getElementById('fileExplorer');
            explorer.innerHTML = '';

            function renderItems(items, path = '') {
                Object.keys(items).forEach(name => {
                    const item = items[name];
                    const itemPath = path ? `${path}/${name}` : name;
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.path = itemPath;
                    
                    fileItem.innerHTML = `
                        ${getFileIcon(name, item.type)}
                        <span class="file-name">${name}</span>
                    `;

                    if (item.type === 'file') {
                        fileItem.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openFile(itemPath, item);
                        });
                        
                        fileItem.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            showContextMenu(e, itemPath);
                        });
                    }

                    explorer.appendChild(fileItem);

                    if (item.type === 'folder' && item.children) {
                        renderItems(item.children, itemPath);
                    }
                });
            }

            renderItems(fileSystem);
        }

        function openFile(path, fileData) {
            // Check if file is already open
            const existingFile = openFiles.find(f => f.path === path);
            if (existingFile) {
                setActiveFile(existingFile);
                return;
            }

            const file = {
                path: path,
                name: path.split('/').pop(),
                content: fileData.content,
                language: fileData.language
            };

            openFiles.push(file);
            addTab(file);
            setActiveFile(file);
        }

        function addTab(file) {
            const tabBar = document.getElementById('tabBar');
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.path = file.path;
            
            tab.innerHTML = `
                <div class="tab-icon">${getFileIconHTML(file.name, 'file')}</div>
                <span class="tab-name">${file.name}</span>
                <i class="fas fa-times tab-close" onclick="closeFile('${file.path}')"></i>
                <div class="tab-unsaved"></div>
            `;

            tab.addEventListener('click', (e) => {
                if (!e.target.classList.contains('tab-close')) {
                    const fileToOpen = openFiles.find(f => f.path === file.path);
                    setActiveFile(fileToOpen);
                }
            });

            // Add right-click context menu
            tab.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showTabContextMenu(e, file.path);
            });

            tabBar.appendChild(tab);
        }

        function getFileIconHTML(filename, type) {
            if (type === 'folder') {
                return '<i class="fas fa-folder" style="color: #ffd700;"></i>';
            }
            
            const extension = getFileExtension(filename);
            const iconMap = {
                'js': '<i class="fab fa-js-square" style="color: #f7df1e;"></i>',
                'html': '<i class="fab fa-html5" style="color: #e34c26;"></i>',
                'css': '<i class="fab fa-css3-alt" style="color: #1572b6;"></i>',
                'json': '<i class="fas fa-file-code" style="color: #000;"></i>',
                'md': '<i class="fab fa-markdown" style="color: #083fa1;"></i>',
                'py': '<i class="fab fa-python" style="color: #3776ab;"></i>',
                'java': '<i class="fab fa-java" style="color: #007396;"></i>',
                'cpp': '<i class="fas fa-file-code" style="color: #00599c;"></i>',
                'php': '<i class="fab fa-php" style="color: #777bb4;"></i>',
                'ts': '<i class="fab fa-js-square" style="color: #3178c6;"></i>',
                'vue': '<i class="fab fa-vuejs" style="color: #4fc08d;"></i>',
                'react': '<i class="fab fa-react" style="color: #61dafb;"></i>'
            };
            
            return iconMap[extension] || '<i class="fas fa-file" style="color: #888;"></i>';
        }

        function setActiveFile(file) {
            activeFile = file;
            
            // Update tab active state
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.path === file.path) {
                    tab.classList.add('active');
                }
            });

            // Update file explorer active state
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.path === file.path) {
                    item.classList.add('active');
                }
            });

            // Update editor
            if (editor) {
                editor.setValue(file.content);
                monaco.editor.setModelLanguage(editor.getModel(), file.language);
                document.getElementById('languageText').textContent = 
                    file.language.charAt(0).toUpperCase() + file.language.slice(1);
                
                // Track content for unsaved changes
                trackFileContent(file);
            }
        }

        function closeFile(path) {
            const fileIndex = openFiles.findIndex(f => f.path === path);
            if (fileIndex === -1) return;

            openFiles.splice(fileIndex, 1);
            
            // Remove tab
            const tab = document.querySelector(`.tab[data-path="${path}"]`);
            if (tab) tab.remove();

            // If closing active file, switch to another file or clear editor
            if (activeFile && activeFile.path === path) {
                if (openFiles.length > 0) {
                    setActiveFile(openFiles[0]);
                } else {
                    activeFile = null;
                    if (editor) {
                        editor.setValue('// No files open');
                        monaco.editor.setModelLanguage(editor.getModel(), 'plaintext');
                        document.getElementById('languageText').textContent = 'Plain Text';
                    }
                }
            }
        }

        function showContextMenu(e, path) {
            e.preventDefault();
            contextMenuTarget = path;
            
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextMenuTarget = null;
        }

        function showTabContextMenu(e, path) {
            e.preventDefault();
            tabContextMenuTarget = path;
            
            const menu = document.getElementById('tabContextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function hideTabContextMenu() {
            document.getElementById('tabContextMenu').style.display = 'none';
            tabContextMenuTarget = null;
        }

        function closeTab() {
            if (tabContextMenuTarget) {
                closeFile(tabContextMenuTarget);
            }
            hideTabContextMenu();
        }

        function closeOtherTabs() {
            if (tabContextMenuTarget) {
                const tabsToClose = openFiles.filter(f => f.path !== tabContextMenuTarget);
                tabsToClose.forEach(file => closeFile(file.path));
            }
            hideTabContextMenu();
        }

        function closeAllTabs() {
            const allTabs = [...openFiles];
            allTabs.forEach(file => closeFile(file.path));
            hideTabContextMenu();
        }

        function duplicateTab() {
            if (tabContextMenuTarget) {
                const sourceFile = openFiles.find(f => f.path === tabContextMenuTarget);
                if (sourceFile) {
                    const originalName = sourceFile.name;
                    const nameWithoutExt = originalName.split('.').slice(0, -1).join('.');
                    const extension = originalName.split('.').pop();
                    const newName = `${nameWithoutExt}_copy.${extension}`;
                    
                    const newFile = {
                        path: newName,
                        name: newName,
                        content: sourceFile.content,
                        language: sourceFile.language
                    };
                    
                    openFiles.push(newFile);
                    addTab(newFile);
                    setActiveFile(newFile);
                }
            }
            hideTabContextMenu();
        }

        function saveTab() {
            if (tabContextMenuTarget && activeFile) {
                // Mark as saved (remove unsaved indicator)
                markTabAsSaved(tabContextMenuTarget);
                addMessage(`File "${activeFile.name}" saved successfully!`, true);
            }
            hideTabContextMenu();
        }

        function markTabAsUnsaved(path) {
            const tab = document.querySelector(`.tab[data-path="${path}"]`);
            if (tab) {
                tab.classList.add('tab-dirty');
                const unsavedIndicator = tab.querySelector('.tab-unsaved');
                if (unsavedIndicator) {
                    unsavedIndicator.classList.add('show');
                }
            }
        }

        function markTabAsSaved(path) {
            const tab = document.querySelector(`.tab[data-path="${path}"]`);
            if (tab) {
                tab.classList.remove('tab-dirty');
                const unsavedIndicator = tab.querySelector('.tab-unsaved');
                if (unsavedIndicator) {
                    unsavedIndicator.classList.remove('show');
                }
            }
        }

        function createNewFile() {
            showModal('New File', 'Enter file name (e.g., script.js)', (name) => {
                if (name) {
                    const extension = getFileExtension(name);
                    const language = getLanguageFromExtension(extension);
                    
                    fileSystem[name] = {
                        type: 'file',
                        content: '',
                        language: language
                    };
                    
                    renderFileExplorer();
                    openFile(name, fileSystem[name]);
                }
            });
        }

        function createNewFolder() {
            showModal('New Folder', 'Enter folder name', (name) => {
                if (name) {
                    fileSystem[name] = {
                        type: 'folder',
                        children: {}
                    };
                    renderFileExplorer();
                }
            });
        }

        function renameFile() {
            if (!contextMenuTarget) return;
            
            const currentName = contextMenuTarget.split('/').pop();
            showModal('Rename File', 'Enter new name', (newName) => {
                if (newName && newName !== currentName) {
                    // Simple rename logic (for demo purposes)
                    const parts = contextMenuTarget.split('/');
                    const oldName = parts.pop();
                    const parentPath = parts.join('/');
                    
                    if (parentPath) {
                        const parent = getFileByPath(parentPath);
                        if (parent && parent.children) {
                            parent.children[newName] = parent.children[oldName];
                            delete parent.children[oldName];
                        }
                    } else {
                        fileSystem[newName] = fileSystem[oldName];
                        delete fileSystem[oldName];
                    }
                    
                    // Update open files
                    openFiles.forEach(file => {
                        if (file.path === contextMenuTarget) {
                            file.path = parentPath ? `${parentPath}/${newName}` : newName;
                            file.name = newName;
                        }
                    });
                    
                    renderFileExplorer();
                    updateTabs();
                }
            });
            hideContextMenu();
        }

        function deleteFile() {
            if (!contextMenuTarget) return;
            
            if (confirm(`Are you sure you want to delete ${contextMenuTarget.split('/').pop()}?`)) {
                const parts = contextMenuTarget.split('/');
                const name = parts.pop();
                const parentPath = parts.join('/');
                
                if (parentPath) {
                    const parent = getFileByPath(parentPath);
                    if (parent && parent.children) {
                        delete parent.children[name];
                    }
                } else {
                    delete fileSystem[name];
                }
                
                // Close if open
                closeFile(contextMenuTarget);
                
                renderFileExplorer();
            }
            hideContextMenu();
        }

        function duplicateFile() {
            if (!contextMenuTarget) return;
            
            const sourceFile = getFileByPath(contextMenuTarget);
            if (sourceFile && sourceFile.type === 'file') {
                const originalName = contextMenuTarget.split('/').pop();
                const nameWithoutExt = originalName.split('.').slice(0, -1).join('.');
                const extension = originalName.split('.').pop();
                const newName = `${nameWithoutExt}_copy.${extension}`;
                
                const parts = contextMenuTarget.split('/');
                parts.pop();
                const parentPath = parts.join('/');
                
                if (parentPath) {
                    const parent = getFileByPath(parentPath);
                    if (parent && parent.children) {
                        parent.children[newName] = {
                            ...sourceFile,
                            content: sourceFile.content
                        };
                    }
                } else {
                    fileSystem[newName] = {
                        ...sourceFile,
                        content: sourceFile.content
                    };
                }
                
                renderFileExplorer();
            }
            hideContextMenu();
        }

        function getFileByPath(path) {
            const parts = path.split('/');
            let current = fileSystem;
            
            for (const part of parts) {
                if (current[part]) {
                    current = current[part];
                } else {
                    return null;
                }
            }
            
            return current;
        }

        function updateTabs() {
            // Re-render all tabs
            const tabBar = document.getElementById('tabBar');
            tabBar.innerHTML = '';
            
            openFiles.forEach(file => {
                addTab(file);
            });
            
            if (activeFile) {
                setActiveFile(activeFile);
            }
        }

        function showModal(title, placeholder, callback) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalInput').placeholder = placeholder;
            document.getElementById('modalInput').value = '';
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modalInput').focus();
            modalCallback = callback;
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            modalCallback = null;
        }

        function confirmModal() {
            const value = document.getElementById('modalInput').value.trim();
            if (modalCallback) {
                modalCallback(value);
            }
            closeModal();
        }

        // Chat Bot Functions
        function toggleChat() {
            chatOpen = !chatOpen;
            const chatPanel = document.getElementById('chatPanel');
            const chatToggle = document.getElementById('chatToggle');
            
            if (chatOpen) {
                chatPanel.classList.add('open');
                chatToggle.innerHTML = '<i class="fas fa-times"></i>';
                document.getElementById('chatInput').focus();
                
                // Test API connection on first open
                if (chatHistory.length === 0) {
                    testAPIConnection();
                }
            } else {
                chatPanel.classList.remove('open');
                chatToggle.innerHTML = '<i class="fas fa-robot"></i>';
            }
        }

        async function testAPIConnection() {
            try {
                addMessage('Testing Gemini API connection...', false);
                const testResponse = await callGeminiAPI('Hello! Please respond with "Gemini API connection successful" to confirm the integration is working.');
                addMessage(testResponse, false);
            } catch (error) {
                addMessage(`API Test Failed: ${error.message}`, false);
                console.error('API Test Error:', error);
            }
        }

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            
            if (isUser) {
                messageDiv.innerHTML = `<strong>You:</strong> ${escapeHtml(content)}`;
            } else {
                messageDiv.innerHTML = `<strong>AI Assistant:</strong> ${formatAIResponse(content)}`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store in chat history
            chatHistory.push({ content, isUser, timestamp: Date.now() });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatAIResponse(text) {
            // Convert markdown-style code blocks to HTML
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert line breaks to HTML
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('show');
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSend');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input while processing
            input.disabled = true;
            sendBtn.disabled = true;
            input.value = '';
            
            // Add user message
            addMessage(message, true);
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Prepare context for AI
                const context = getCodeContext();
                const prompt = buildPrompt(message, context);
                
                // Call Gemini API
                const response = await callGeminiAPI(prompt);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add AI response
                addMessage(response);
                
                // Check if response contains code that can be applied
                checkForCodeActions(response);
                
            } catch (error) {
                hideTypingIndicator();
                addMessage(`Sorry, I encountered an error: ${error.message}. Please try again.`);
                console.error('Chat error:', error);
            } finally {
                // Re-enable input
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function getCodeContext() {
            const context = {
                currentFile: null,
                openFiles: [],
                fileSystem: fileSystem
            };
            
            if (activeFile) {
                context.currentFile = {
                    name: activeFile.name,
                    path: activeFile.path,
                    content: activeFile.content,
                    language: activeFile.language
                };
            }
            
            context.openFiles = openFiles.map(file => ({
                name: file.name,
                path: file.path,
                language: file.language
            }));
            
            return context;
        }

        function buildPrompt(userMessage, context) {
            let prompt = `You are an AI coding assistant helping a developer in a web-based code editor. `;
            
            if (context.currentFile) {
                prompt += `\n\nCurrent file: ${context.currentFile.name} (${context.currentFile.language})\n`;
                prompt += `Current file content:\n\`\`\`${context.currentFile.language}\n${context.currentFile.content}\n\`\`\`\n`;
            }
            
            if (context.openFiles.length > 0) {
                prompt += `\nOpen files: ${context.openFiles.map(f => f.name).join(', ')}\n`;
            }
            
            prompt += `\nUser request: ${userMessage}\n\n`;
            prompt += `Please provide helpful code assistance. If you suggest code changes, format them clearly with proper syntax highlighting. `;
            prompt += `If the user asks to modify existing code, provide the complete modified code or specific changes needed.`;
            
            return prompt;
        }

        async function callGeminiAPI(prompt) {
            console.log('Calling Gemini API with prompt:', prompt.substring(0, 100) + '...');
            
            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048,
                        }
                    })
                });
                
                console.log('API Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error(`API request failed: ${response.status} ${response.statusText}. ${errorText}`);
                }
                
                const data = await response.json();
                console.log('API Response data:', data);
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const result = data.candidates[0].content.parts[0].text;
                    console.log('AI Response:', result);
                    return result;
                } else if (data.error) {
                    throw new Error(`Gemini API Error: ${data.error.message || 'Unknown error'}`);
                } else {
                    console.error('Unexpected response format:', data);
                    throw new Error('Invalid response format from Gemini API');
                }
                
            } catch (error) {
                console.error('Gemini API call failed:', error);
                
                // Provide more specific error messages
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Network error: Unable to connect to Gemini API. Please check your internet connection.');
                } else if (error.message.includes('403')) {
                    throw new Error('API Key Error: Invalid or unauthorized API key. Please check your Gemini API key.');
                } else if (error.message.includes('429')) {
                    throw new Error('Rate Limit: Too many requests. Please wait a moment and try again.');
                } else if (error.message.includes('quota')) {
                    throw new Error('Quota Exceeded: Your Gemini API quota has been exceeded. Please check your billing.');
                } else {
                    throw error;
                }
            }
        }

        function checkForCodeActions(response) {
            // Look for code blocks in the response
            const codeBlocks = response.match(/```(\w+)?\n([\s\S]*?)```/g);
            
            if (codeBlocks && activeFile) {
                // Add action buttons for applying code
                const messagesContainer = document.getElementById('chatMessages');
                const lastMessage = messagesContainer.lastElementChild;
                
                if (lastMessage && lastMessage.classList.contains('ai')) {
                    const actionButtons = document.createElement('div');
                    actionButtons.className = 'code-action-buttons';
                    actionButtons.innerHTML = `
                        <button class="code-action-btn" onclick="applyCodeToCurrentFile('${escapeHtml(response)}')">
                            Apply to Current File
                        </button>
                        <button class="code-action-btn secondary" onclick="createNewFileFromCode('${escapeHtml(response)}')">
                            Create New File
                        </button>
                    `;
                    lastMessage.appendChild(actionButtons);
                }
            }
        }

        function applyCodeToCurrentFile(response) {
            if (!activeFile) {
                addMessage('No file is currently open. Please open a file first.', true);
                return;
            }
            
            // Extract code from response
            const codeMatch = response.match(/```(\w+)?\n([\s\S]*?)```/);
            if (codeMatch) {
                const code = codeMatch[2];
                if (editor) {
                    editor.setValue(code);
                    activeFile.content = code;
                    
                    // Update file system
                    const file = getFileByPath(activeFile.path);
                    if (file) {
                        file.content = code;
                    }
                    
                    addMessage('Code has been applied to the current file!', true);
                }
            } else {
                addMessage('No code found in the AI response to apply.', true);
            }
        }

        function createNewFileFromCode(response) {
            const codeMatch = response.match(/```(\w+)?\n([\s\S]*?)```/);
            if (codeMatch) {
                const language = codeMatch[1] || 'txt';
                const code = codeMatch[2];
                
                // Generate filename based on language
                const extensions = {
                    'javascript': 'js',
                    'html': 'html',
                    'css': 'css',
                    'python': 'py',
                    'java': 'java',
                    'cpp': 'cpp',
                    'c': 'c',
                    'php': 'php',
                    'ruby': 'rb',
                    'go': 'go',
                    'rust': 'rs',
                    'sql': 'sql',
                    'xml': 'xml',
                    'yaml': 'yaml',
                    'json': 'json'
                };
                
                const extension = extensions[language] || 'txt';
                const filename = `ai_generated_${Date.now()}.${extension}`;
                
                // Create new file
                fileSystem[filename] = {
                    type: 'file',
                    content: code,
                    language: language
                };
                
                renderFileExplorer();
                openFile(filename, fileSystem[filename]);
                
                addMessage(`New file "${filename}" created with the AI-generated code!`, true);
            } else {
                addMessage('No code found in the AI response to create a file from.', true);
            }
        }

        // Chat input event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            // Auto-resize textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Send message on Enter (but allow Shift+Enter for new lines)
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // Event listeners
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.file-context-menu')) {
                hideContextMenu();
            }
            if (!e.target.closest('.tab-context-menu')) {
                hideTabContextMenu();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideContextMenu();
                hideTabContextMenu();
                closeModal();
            }
            
            if (e.key === 'Enter' && document.getElementById('modal').style.display === 'flex') {
                confirmModal();
            }
        });

        // Track editor changes for unsaved indicators
        let lastSavedContent = {};
        
        // Auto-save content when editor changes
        setInterval(() => {
            if (activeFile && editor) {
                const currentContent = editor.getValue();
                const originalContent = lastSavedContent[activeFile.path] || activeFile.content;
                
                // Check if content has changed
                if (currentContent !== originalContent) {
                    activeFile.content = currentContent;
                    
                    // Update file system
                    const file = getFileByPath(activeFile.path);
                    if (file) {
                        file.content = currentContent;
                    }
                    
                    // Mark as unsaved
                    markTabAsUnsaved(activeFile.path);
                }
            }
        }, 1000);

        // Track when files are opened to set initial saved state
        function trackFileContent(file) {
            lastSavedContent[file.path] = file.content;
            markTabAsSaved(file.path);
        }

        // Initialize
        renderFileExplorer();
    </script>
</body>
</html>
